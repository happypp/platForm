<?xml version="1.0" encoding="UTF-8"?>
<project name="platform" basedir="./" default="package-all">
    <!-- 定义属性 -->
    <property name="app.name" value="platform"/>
    <property environment="env"/>
    <!-- ant的环境变量(linux需要配置） -->
    <property name="ant.home" value="${env.ANT_HOME}"/>
    <!-- java的环境变量(linux需要配置） -->
    <property name="java.home" value="${env.JAVA_HOME}"/>
    <!--  项目结构目录定义  -->
    <property name="src.dir" value="${basedir}/src/main/java"/>
    <property name="resource.dir" value="${basedir}/src/main/resources"/>
    <property name="web.dir" value="${basedir}/src/main/webapp"/>
    <property name="lib.dir" value="${web.dir}/WEB-INF/lib"/>
    <!-- 指明svnant任务插件用到的jar文件的路径 -->
    <property name="svnant.lib" value="${ant.home}/lib"/>
    <!-- 指明编译时需要用到的其他jar文件的路径（需要在当前文件下创建该目录） -->
    <property name="other.lib" value="${basedir}/other_lib"/>
    <!-- 本地编译路径 -->
    <property name="build.dir" value="${basedir}"/>
    <property name="build.classes" value="${build.dir}/src/main/webapp/WEB-INF/classes"/>
    <property name="build.claimApp" value="${build.dir}/src/main/webapp"/>
    <!-- 指定打包后war文件的名称 -->
    <property name="war_name" value="platform"/>
    <!-- 指定打包后zip_name文件的名称 -->
    <property name="zip_name" value="incremental_package"/>
    <!-- war打包具体路径 -->
    <property name="target.dir" value="/Program/target/${war_name}/"/>
    <!-- 当前时间及格式 -->
    <tstamp> <format property="current_time" pattern="yyyyMMddhhmm" locale="zh"/></tstamp>

    <path id="classpath">
        <fileset dir="${lib.dir}">
            <include name="**/*.jar"/>
        </fileset>
    </path>
    <!-- path to the svnant libraries. Usually they will be located in ANT_HOME/lib -->
    <path id="svnant_classpath">
        <fileset dir="${svnant.lib}">
            <include name="**/*.jar"/>
        </fileset>
    </path>

    <!-- 清除旧的编译文件 -->
    <target name="clean-class" >
        <echo message="开始清空classes文件夹内之前编译生成的旧的类文件，请稍后..." />
        <delete dir="${build.classes}"/>
        <echo message="classes文件清空完毕。" />
    </target>

    <!-- 初始化class路径 -->
    <target name="init-class" depends="clean-class">
        <mkdir dir="${build.classes}"/>
        <echo message="class路径：${build.classes}已创建完毕。" />
    </target>

    <!-- 只编译java文件 -->
    <target name="compile-jdk6" depends="init-class">
        <echo message="根据svn文件开始编译class文件..." ></echo>
        <echo message="**** copy resources to classes dir ****"></echo>
        <copy todir="${build.classes}" preservelastmodified="true">
            <fileset dir="${resource.dir}">
                <include name="**/*.properties"/>
                <include name="**/*.xml"/>
                <include name="**/*.ftl"/>
            </fileset>
            <fileset dir="${src.dir}">
                <include name="**/*.properties"/>
                <include name="**/*.xml"/>
                <include name="**/*.ftl"/>
                <include name="**/*.sql"/>
            </fileset>
        </copy>
        <echo message="**** compile sources to classes dir ****"></echo>
        <javac srcdir="${src.dir}" destdir="${build.classes}"
               target="1.7" source="1.7" encoding="UTF-8" fork="true"
               memoryInitialSize="512m" memoryMaximumSize="1024m"
               debug="true" debuglevel="lines,vars,source"
               includeantruntime="true">
            <classpath refid="classpath"/>
        </javac>
        <echo message="class文件编译成功！" ></echo>
    </target>

    <!-- 生成war包 -->
    <target name="generate-war" depends="compile-jdk6">
        <echo message="正在生成${war_name}.war包..." ></echo>
        <war warfile="${build.dir}/${war_name}.war" webxml="${build.claimApp}/WEB-INF/web.xml" excludes="*.svn">
            <lib dir="${build.claimApp}/WEB-INF/lib"/>
            <classes dir="${build.claimApp}/WEB-INF/classes"/>
            <fileset dir="${build.claimApp}"/>
        </war>
        <echo message="${war_name}.war包生成成功！" ></echo>
    </target>
    <!-- 检查是否存在已经部署的旧的目标war包。 -->
    <target name="old-war-exist-check">
        <echo message="检查是否存在旧的同名war文件..." ></echo>
        <available file="${build.dir}/${war_name}.war"  property="old-war-isexist"/>
    </target>


</project>